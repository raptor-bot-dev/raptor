# Session Retro: 2026-01-20 (10x Token Amount Bug - v4.6 DECIMALS FIX)

## Problem Statement

**Emergency sell failing with `NotEnoughTokensToSell` error** - Pump.fun program rejecting sells because requested amount was **exactly 10x** the wallet's actual balance.

```
AnchorError thrown in programs/pump/src/lib.rs:584. Error Code: NotEnoughTokensToSell. Error Number: 6023.
Left: 205478149265      (available)
Right: 2054781492657    (requested - 10x too high!)
```

## Root Cause Analysis

### Issue 1: 10x Amount Mismatch (Initial diagnosis - WRONG)
The previous understanding was that `position.size_tokens` storage was inconsistent (manual buys vs autohunt), causing a decimal multiplication bug. However, this was **not the real issue**.

### Issue 2: Token-2022 ATA Derivation (ACTUAL ROOT CAUSE)
The `getTokenBalanceRaw()` function in `solanaExecutor.ts` was using `getAssociatedTokenAddress(mint, wallet)` **without specifying the token program**. This defaults to standard SPL token (TOKEN_PROGRAM_ID).

**BUT** pump.fun tokens use **Token-2022** (TOKEN_2022_PROGRAM_ID), which derives ATAs at **different addresses**.

Result: The function was checking the wrong ATA (standard SPL) which had 0 balance, while the real Token-2022 ATA had tokens.

### Timeline of Bugs in This Session

1. **v134**: First deployment with `sellPercent` option - showed `PREFLIGHT_ZERO_BALANCE` instead of 10x error
2. **Investigation**: Logs showed `getTokenProgramForMint() Mint X uses Token-2022 program` but `getTokenBalanceRaw()` wasn't using this
3. **v136**: Fixed `getTokenBalanceRaw()` to detect and use correct token program for ATA derivation

## Fixes Implemented

### Fix 1: v4.6 DECIMALS FIX - Percent-based selling (v134)
```typescript
// Before: Used position.size_tokens (potentially wrong decimals)
const tokensToSell = position.size_tokens;
executeSellWithKeypair(mint, tokensToSell, keypair);

// After: Fetch fresh balance from chain, sell by percent
executeSellWithKeypair(mint, 0, keypair, { sellPercent: 100 });
```

### Fix 2: Token-2022 ATA Detection (v136) - THE REAL FIX
```typescript
// Before: Only checked standard SPL ATA
const ata = await getAssociatedTokenAddress(mint, wallet);

// After: Detect token program and derive correct ATA
const tokenProgramId = await getTokenProgramForMint(this.connection, mint);
const ata = await getAssociatedTokenAddress(mint, wallet, false, tokenProgramId);
```

### Fix 3: Fly.io Autostop Configuration (v135)
Bot was stopping due to `autostop: true` with `min_machines_running: 0`. Fixed:
- `fly.toml`: `auto_stop_machines = false`, `min_machines_running = 1`
- Also fixed dockerfile path: `dockerfile = "../../Dockerfile.bot"` (relative to fly.toml)

## Files Changed

| File | Change |
|------|--------|
| `apps/executor/src/chains/solana/solanaExecutor.ts` | Added `getTokenProgramForMint` import, fixed `getTokenBalanceRaw()` to use detected token program |
| `apps/bot/src/services/emergencySellService.ts` | Changed to use `sellPercent: 100` instead of `tokensToSell` |
| `apps/hunter/src/loops/execution.ts` | Removed decimal compensation logic, use `sellPercent` option |
| `apps/bot/src/handlers/sell.ts` | Updated to use `sellPercent` option |
| `apps/bot/fly.toml` | Fixed dockerfile path, autostop settings |

## Deployment History

| Version | Timestamp | Changes | Result |
|---------|-----------|---------|--------|
| v134 | 12:42 | sellPercent option, preflight checks | `PREFLIGHT_ZERO_BALANCE` (wrong ATA) |
| v135 | 13:26 | fly.toml autostop fix | Bot stayed running |
| v136 | 13:50 | Token-2022 ATA detection | **PENDING VERIFICATION** |

## What Went Wrong

1. **Misdiagnosed root cause initially** - Thought it was decimal multiplication, actually was ATA derivation
2. **Didn't connect the dots** - Saw `getTokenProgramForMint() uses Token-2022` in logs but didn't realize `getTokenBalanceRaw()` wasn't using it
3. **Multiple compounding issues** - Fly.io autostop + ATA bug + decimal concerns all overlapping

## What Went Right

1. **Preflight check caught the issue early** - `PREFLIGHT_ZERO_BALANCE` was clearer than the 10x error
2. **Debug logging helped** - Added logging to `getTokenBalanceRaw()` to see which ATA was being checked
3. **Incremental deployment** - Each version had one fix, made it easier to isolate issues

## Lessons Learned

1. **Token-2022 ATAs are at different addresses** - Always use detected token program when deriving ATAs
2. **Fresh on-chain data > stored data** - Fetching balance from chain eliminates decimal confusion
3. **Read the existing code** - `getTokenProgramForMint()` already existed, just wasn't being used everywhere
4. **Fly.io autostop is bad for Telegram bots** - Long-polling bots need to run continuously

## Current Status

- **v136 deployed** to raptor-bot with Token-2022 ATA fix
- **Bot is running** and should stay running (autostop disabled)
- **Emergency sell untested** - User needs to test on active positions

## Next Steps

1. **Test emergency sell** on one of the 4 active positions:
   - PUMP (Ahte7zvpjbroToRRoA3MzvuDz6XGFgvWrBPGj1hfpump)
   - REDBULL (BDVhcvNs7PZzfJvoekLvxyR5i9BUT5emwbRhfyU6pump)
   - Watcher (2BVSFGaxPFNPoX1z4orquizM97v4jrxc4XDANQdQpump)
   - HODL (HnbVCGDftjvVxpVPBMYj5Xh8WbARiP4hnFiFfKANqEQx)

2. **Watch logs** for:
   - `getTokenBalanceRaw: ... tokenProgram=Token-2022`
   - `Token balance: X (Y)`
   - Successful sell transaction

3. **If still fails**, check:
   - Is the ATA address correct?
   - Does the wallet actually hold tokens? (check Solscan)
   - Are there other issues with the sell instruction?

## Session Stats

- **Duration**: ~2 hours
- **Commits**: 3
  - `1e24662` fix(deploy): correct dockerfile path in fly.toml
  - `c4a1f50` fix(executor): detect Token-2022 program for correct ATA in getTokenBalanceRaw
  - (v134 commit from previous session: sellPercent option)
- **Deployments**: 3 (v134, v135, v136)
- **Critical bugs found**: 2 (ATA derivation, Fly autostop)

---
*Generated by retrospective - RAPTOR Bug Fix Session - 2026-01-20*
