# Changelog.md

Keep this log short and append-only. Use ISO dates.

## 2026-01-19
- **feat(hunter): token launch filtering modes**
  - Added 3 configurable filter modes: strict, moderate (default), light
  - Strict: Require socials + 3s delay + activity check
  - Moderate: 3s delay + activity check only (checks bondingCurveProgress > 0.5%)
  - Light: Require at least 1 social signal, no delay (fastest entry)
  - Activity check uses pump.fun API to verify early buyer interest
  - Reduces wasted gas and RPC calls on dead tokens
  - Migration 017 adds filter_mode column to strategies
  - Settings UI updated with Filter Mode selection

## 2026-01-18
- **fix(db): allow retryable auto jobs to reuse executions**
  - Added migration 016 to extend `reserve_trade_budget` with `p_allow_retry`
  - FAILED executions can be reused for retryable trade job attempts
  - Prevents immediate "Already executed" failures on queued retries
- **fix(hunter): per-user snipe scoring + opportunity lifecycle cleanup**
  - Score/metadata fetch now runs per snipe mode (speed vs quality) in parallel
  - Opportunities stay EXECUTING until DB terminal state (no early COMPLETED)
  - Auto-execute disabled blocks job creation (records QUALIFIED only)
  - Enforce `token_allowlist` when present
  - Remove unused `priority_fee_lamports` from job payloads (chain_settings remains source)
- **fix(bot): legacy hunt callbacks redirect to new panels**
  - All `hunt_*` callbacks open new Arm/Disarm flow and Settings
  - Snipe mode UI normalized to speed/quality (balanced treated as quality)
  - Slippage prompt text aligned to 1-99% validation
- **fix(shared): handle object errors in parseError** (d25ae0d)
  - Supabase errors are plain objects (not Error instances) thrown via `if (error) throw error;`
  - parseError was calling String(error) → "[object Object]" instead of real message
  - Now extracts .message, .error, or .details from object errors
  - Fixes unhelpful error messages in job failure logs
- **fix(hunter): add job staleness check to ExecutionLoop** (d1b86f3)
  - Jobs older than 60 seconds are CANCELED (not FAILED) to avoid tripping circuit breaker
  - Pump.fun token launch windows expire quickly; stale jobs are useless
  - Fixes circuit breaker getting repeatedly tripped by old jobs failing
- **fix(hunter): relax scoring hard stops for pump.pro tokens**
  - pump.fun API returning HTTP 530 for pump.pro tokens AND Metaplex metadata doesn't exist
  - Temporarily changed metadata rules from hard stops to soft failures:
    - `has_metadata_uri`, `has_twitter`, `has_website`, `has_profile_image`
  - pump.pro tokens without metadata now use fallback name/symbol (mint-based)
  - Tokens can now pass scoring and be traded even without full metadata
  - TODO: Re-enable hard stops when pump.fun API is stable
- **fix(hunter): pump.pro on-chain metadata fallback**
  - pump.fun API returning HTTP 530 (service unavailable) for pump.pro tokens
  - Added fallback to fetch metadata from on-chain Metaplex Metadata Account
  - Fixed PumpFunApiResponse type to check for uri/metadata_uri fields (not just image_uri)
  - Tokens now get proper name/symbol/uri even when API is down
  - Fixes 100% rejection rate ("score: 0") for pump.pro tokens
- **fix(hunter): pump.pro API metadata fetch** (7e999bc)
  - pump.pro instructions don't include inline metadata like pump.fun
  - Detect pump.pro by discriminator, then fetch from frontend-api.pump.fun
  - 3s timeout on API call with graceful fallback
  - Fixes parse failures for all pump.pro token detections
- **fix(hunter): add pump.pro create discriminator** (15746be)
  - pump.pro uses new discriminator: `[147,241,123,100,244,132,174,118]`
  - PumpFunMonitor now checks all 3: legacy create, create_v2, pump.pro
  - Fixes 100% token parse failure on pump.pro transactions
  - Also reset circuit breaker (190 consecutive failures → 0)
- **fix(bot): snipe mode panel errors** (5761fb9)
  - Remove checkmark emoji from buttons (violates panelKit no-emoji rule)
  - Use "[x] Speed" / "[x] Quality" for selected state instead
  - Add early return when clicking already-selected mode
- **fix(executor): prevent BigInt underflow and Jupiter slippage overflow** (565594f)
  - pumpFun.ts: Add validation in calculateBuyOutput/calculateSellOutput
  - jupiter.ts: Clamp slippageBps to 9900 max (99%)
  - supabase.ts: Fix TypeScript type errors with 'as const' assertions
  - Root cause: User had 1000% slippage causing negative BigInt calculations
- **fix(tpsl): standardize on uuid_id and fix critical RPC bugs** (cf9cb34)
  - P0: Migration 015 - All RPC functions now use `uuid_id` (was INTEGER `id`)
  - P0: Backfill NULL `uuid_id` values + add NOT NULL constraint
  - P0: Add unique index on `uuid_id` for race condition prevention
  - P1: Add `uuid_id` field to PositionV31 TypeScript interface
  - P1: Add `triggerExitAtomically()` wrapper in supabase.ts
  - P1: Fix `closePositionV31()` to use `uuid_id` for lookups
  - P2: Remove trigger-time notifications (moved to post-sell with real data)
  - P2: TRADE_DONE is now BUY-only; SELL uses TP_HIT/SL_HIT/etc.
  - Legacy monitor now uses atomic claim before creating exit jobs
  - All handlers (buy, sell, positions) now use uuid_id consistently
- **fix(tpsl): audit fixes for notification delivery and state machine** (bbfdd53)
  - P0: Start NotificationPoller in bot/index.ts (was never started - notifications never delivered)
  - P0: Fix notification type mapping: TAKE_PROFIT → TP_HIT, STOP_LOSS → SL_HIT
  - P0: Fix payload structure to match formatter expectations (tokenSymbol, pnlPercent, etc.)
  - P0: Fix createPositionV31 to use `tg_id` column (was using non-existent `user_id`)
  - P0: Populate trigger_state, tp_price, sl_price, bonding_curve at position creation
  - P1: Add markPositionExecuting, markTriggerCompleted, markTriggerFailed RPC wrappers
  - P1: Call state transitions in execution.ts before/after sell transactions
  - P1: Add trigger_state check to legacy positions.ts monitor (prevent duplicates)
  - P2: Use stored position.tp_price/sl_price when available (not strategy recompute)
  - Added getOpportunityById() to fetch bonding_curve from opportunity
- **fix(hunter): enforce metadata + dev-holdings hard stops**
  - Require metadata URI, X/Twitter, website, and image (Telegram optional)
  - Enforce creator holdings <= 10% of supply (hard stop)
  - Force metadata fetch even in speed snipe mode
- **fix(tpsl): improve exit state + notification accuracy**
  - Use position tokenSymbol in TP/SL notifications (not mint)
  - Always persist current_price updates in TP/SL monitor
  - Avoid early EXECUTING state in exit queue/legacy monitor
  - Mark triggers failed on unexpected SELL exceptions
  - Emergency sell notifications now use uuid_id
- **fix(bot): default base autohunt strategy to reduce launch flood**
  - New auto strategies default to stricter limits (positions/exposure/daily spend)
  - Raise min_score and cooldown for conservative default hunting
  - Pristine auto strategies are auto-updated to the new base defaults
- **chore(hunter): disable global deployer blacklist rule**
  - Blacklist enforcement removed until testing is complete
- **feat(bot): add snipe mode selection to Settings**
  - Speed vs Quality options with descriptions
  - Stores selection on the user's AUTO strategy
- **feat(hunter): begin TP/SL Engine implementation (Phase B)**
  - Hybrid architecture: Jupiter polling (3s) + Helius WebSocket activity hints
  - Trigger state machine: MONITORING → TRIGGERED → EXECUTING → COMPLETED
  - Exactly-once semantics via atomic DB claims + idempotency keys
  - Exit queue with backpressure (maxConcurrent=3)
  - Feature-flagged migration path from legacy position monitor
  - Documentation updates: Architecture.md, CLAUDE.md, DESIGN.md, Reference_docs.md
- **feat(hunter): add pump.pro program support for token detection**
  - pump.fun has upgraded to new program: `proVF4pMXVaYqmy4NjniPh4pqKNfMmsihgd4wdkCX3u`
  - Most tokens now created via pump.pro instead of classic pump.fun
  - Added PUMP_PRO to PROGRAM_IDS in shared config
  - Monitor now subscribes to both pump.fun and pump.pro WebSocket logs
  - Parsing logic checks for Create instructions from both programs
- **fix(executor): clamp slippage to 99% max to prevent negative minTokens**
  - Settings handler now caps slippage input at 99% (was 1000%)
  - pumpFun.ts buy/sell now clamp slippageBps to 9900 max defensively
  - Root cause: User set 1000% slippage → 100000 bps → (10000-100000) = negative
  - This caused RangeError in encodeBuyData for BigUInt64LE
  - Fixed user's strategy slippage_bps from 100000 to 1500 (15%)
  - Reset circuit breaker after 5+ consecutive failures from this bug
- **fix(hunter): add create_v2 discriminator for pump.fun tokens**
  - pump.fun now uses `create_v2` instruction (not legacy `create`)
  - Legacy discriminator: `[24,30,200,40,5,28,7,119]` - sha256("global:create")[0..8]
  - Current discriminator: `[214,144,76,236,95,139,49,180]` - sha256("global:create_v2")[0..8]
  - Monitor now checks for both discriminators
  - Tokens now parsing successfully
- **fix(hunter): include ALT loaded addresses for versioned transactions**
  - Versioned transactions can have accounts in Address Lookup Tables (ALTs)
  - Was only reading `staticAccountKeys`, missing accounts from ALTs
  - Now combines: staticAccountKeys + loadedAddresses.writable + loadedAddresses.readonly
  - This fixes 100% parse failure when pump.fun program ID is in an ALT
- **chore(infra): migrate from QuickNode to Helius paid plan**
  - QuickNode free tier doesn't support `logsSubscribe` WebSocket method
  - Error: "1001 - upstream went away" immediately after subscription
  - Helius paid plan configured via Fly.io secrets
- **docs: document Fly.io auto-deploy from GitHub**
  - MUST_READ/DEPLOYMENT.md updated with auto-deploy section
  - No manual `fly deploy` needed for routine changes

## 2026-01-17
- **fix(hunter): handle both versioned and legacy tx parsing**
  - PumpFunMonitor was only handling versioned transactions (v0)
  - Now correctly handles legacy transactions as well
  - Versioned: staticAccountKeys, compiledInstructions, Uint8Array data
  - Legacy: accountKeys, instructions, base64 string data
  - This was causing 100% of token detections to fail parsing
- **fix(db): reset circuit breaker** (manual intervention)
  - Circuit breaker had 8 consecutive failures (threshold: 5)
  - Reset circuit_open_until and consecutive_failures to allow trades
- **fix(bot): settings panel text input not responding**
  - Added missing v3 autohunt settings session steps to messages.ts handleSessionFlow()
  - Now routes AWAITING_TRADE_SIZE, AWAITING_MAX_POSITIONS, AWAITING_TP_PERCENT,
    AWAITING_SL_PERCENT, AWAITING_SLIPPAGE_BPS, AWAITING_PRIORITY_SOL to handleSettingsInput()
  - Settings panel now properly updates values when user enters text
- **fix(bot): slippage now uses percentage instead of bps**
  - Display: shows "10%" instead of "1000 bps"
  - Input: accepts 1-1000% (converted to bps internally)
  - Better UX for high volatility launches that need 100%+ slippage
- **fix(hunter): pass tgId to executor for MEV/priority settings**
  - Hunter execution loop was not passing user ID to executor
  - Now passes `tgId: job.user_id` to `executeBuyWithKeypair` and `executeSellWithKeypair`
  - Executor now fetches user's chain_settings for priority_sol and anti_mev_enabled
  - Enables Jito MEV protection and custom priority fees for autohunt trades
- **fix(executor): pass priorityFeeSol to PumpFunClient buy/sell**
  - Was hardcoded to 100000 microLamports (~0.00002 SOL)
  - Now uses chain_settings.priority_sol from user preferences
  - Affects both buy and sell transactions on pump.fun bonding curve
- **feat(hunter): add mayhem mode filter**
  - Parse `is_mayhem_mode` from pump.fun Create instruction
  - Skip mayhem mode tokens in OpportunityLoop (low quality launches)
  - Added `isMayhemMode` field to PumpFunEvent interface
- **refactor(shared): remove unused PumpFun API functions**
  - Removed `getRecentTrades()` (never called)
  - Removed `PumpFunTrade` interface (only used by removed function)
  - Removed `parsePumpFunTrade()` (only used by removed function)
- **refactor(executor): remove dead code from pumpFun.ts**
  - Removed `parseCreateEvent()` (returned null)
  - Removed `parseTradeEvent()` (returned null)
  - Removed `PumpFunTrade` interface (only used by removed function)
- **docs: add PumpFun protocol reference to Reference_docs.md**
  - Bonding curve parameters and graduation threshold
  - Key 2025 protocol updates (volume accumulators, fee config, creator vault, mayhem mode)
  - Third-party API references

## 2026-01-16
- **feat(bot): add priority fee and MEV protection settings** (cb35d21)
  - Add Priority Fee setting to Settings UI (0.0001 - 0.01 SOL)
  - Add MEV Protection toggle (Jito) - ON by default
  - Uses chain_settings table for per-chain priority_sol and anti_mev_enabled
  - New callbacks: settings:edit_priority, settings:toggle_mev
- **fix(bot): arm/disarm autohunt bugs**
  - Re-validate settings in confirmArm() before enabling
  - Error handling in confirmDisarm() now updates UI on failure
- **fix(bot): shorten divider and add more bot menu commands** (d8f4dd8)
  - Shortened divider from 20 to 16 chars
  - Added /hunt, /positions, /wallet, /settings commands
- **fix(bot): implement emergency sell service** (P1 critical audit fix)
  - Added apps/bot/src/services/emergencySellService.ts
  - Uses idKeyExitSell for idempotency (one emergency sell per position)
  - Atomic budget reservation and execution tracking
  - High slippage (15%) for faster emergency exits
  - Proper position closing with EMERGENCY trigger
- **docs: deprecate Max Buys/Hour in favor of cooldown_seconds**
  - Max Buys/Hour was a design artifact never implemented in DB
  - cooldown_seconds provides same rate-limiting with better properties
  - Updated DESIGN.md, PROMPT.md, Project_status.md
- refactor(bot): implement v3 terminal UI with autohunt-only panels
- feat(ui): add panelKit.ts HTML renderer with width pad and linux joiners
- feat(ui): add all core panels - Home, Settings, Positions, Withdraw, Help
- feat(ui): add hunt panels - Arm/Disarm confirm, position details, emergency sell
- feat(ui): add notification panels - Hunt Executed/Closed/Skipped/Failed
- refactor(bot): rewrite callback router with new CB.* ID scheme
- remove(bot): disable manual buyer UI flows and callbacks
- remove(bot): disable /deposit command (users fund wallet directly)
- fix(withdraw): implement math validation with 0.01 SOL buffer
- fix(pnl): compute realized PnL from closed positions only
- fix(strategy): correct field names (max_positions, max_per_trade_sol)
- chore(db): add performance indexes for v3 queries

## 2026-01-15
- Added patched UI and placeholder removal work in prior audit iterations.
