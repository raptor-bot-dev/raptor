# Changelog.md

Keep this log short and append-only. Use ISO dates.

## 2026-01-20 (Evening Session - v4.6 DECIMALS FIX)
- **fix(executor): Token-2022 ATA derivation in getTokenBalanceRaw** (c4a1f50)
  - **ROOT CAUSE FOUND**: `getTokenBalanceRaw()` was checking wrong ATA (standard SPL instead of Token-2022)
  - pump.fun tokens use Token-2022 which derives ATAs at different addresses than standard SPL
  - Function was finding 0 balance (wrong ATA) even when wallet held tokens
  - Fix: Import `getTokenProgramForMint`, detect token program, use in `getAssociatedTokenAddress()` call
  - Added debug logging to trace ATA derivation and balance fetches
- **fix(executor): Percent-based selling with fresh on-chain balance** (v134)
  - Added `sellPercent` option to `executeSellWithKeypair()` to avoid decimal confusion
  - Executor now fetches fresh balance from chain at sell time
  - Added preflight balance check: `PREFLIGHT_ZERO_BALANCE` error for empty wallets
  - Updated all callers: emergencySellService.ts, execution.ts, sell.ts
- **fix(deploy): Correct dockerfile path in fly.toml** (1e24662)
  - Changed `dockerfile = "Dockerfile.bot"` to `dockerfile = "../../Dockerfile.bot"` (relative to fly.toml)
  - This fixes local `flyctl deploy` from apps/bot directory
- **fix(infra): Disable Fly.io autostop for Telegram bot** (v135)
  - Bot was stopping with "excess capacity, autostopping machine"
  - fly.toml had correct settings but machine had old config
  - Redeployed to apply: `auto_stop_machines = false`, `min_machines_running = 1`
  - Telegram bots using long-polling need to run continuously

## 2026-01-20 (Earlier Session)
- **fix(infra): Fly.io GitHub App deployment - dockerfile path resolution** (8dc2ee1)
  - raptor-bot was running hunter code instead of Telegram bot code
  - Root cause: `apps/bot/fly.toml` had `dockerfile = "../../Dockerfile.bot"` (relative to fly.toml)
  - Fly.io GitHub App expects paths **relative to repo root**, not fly.toml location
  - Fixed both fly.toml files to use `dockerfile = "Dockerfile.bot"` and `dockerfile = "Dockerfile.hunter"`
  - Created backup GitHub Actions workflow (`.github/workflows/deploy.yml`) for manual deploys
  - Both apps now deploy correctly on push to main
- **fix(executor): IDL-based fee recipient resolution** (ef787c5)
  - Pump fee recipient now resolves from on-chain Global config via pinned IDL
  - Mayhem mode selects reserved fee recipients automatically (no fixed recipient)
  - New override env: `PUMP_OVERRIDE_FEE_RECIPIENT` (escape hatch only)
  - Vendored Pump IDL: `vendor/pump-public-docs/idl/pump.json` (commit `f0ef005c386adeeb783c27fdcc4ddd9d49b255c5`)
  - Note: `PUMP_PRO_FEE_RECIPIENT` is no longer used for normal routing
  - New files:
    - `apps/executor/src/chains/solana/feeRecipient.ts` - decodes BondingCurve + Global, mode-aware selection
    - `apps/executor/src/chains/solana/pumpIdl.ts` - IDL locator + Borsh decoder
  - Dependencies: Added `@coral-xyz/anchor` for IDL decoding
- **fix(executor): token program detection for emergency sell** (cf62b67)
  - Added `getTokenProgramForMint()` to detect TOKEN_PROGRAM_ID vs TOKEN_2022_PROGRAM_ID
  - Mint account owner check determines correct token program
  - ATA derivation now uses detected token program (no hardcoded Token-2022)
  - Fixes `InvalidProgramId` error on `token_program` account for emergency sells
- **fix(audit): pricing, PnL, and pump.pro execution hardening**
  - Added on-chain bonding curve fallback for pricing and market data
  - Quote-based PnL now uses Jupiter sell quotes for graduated tokens (cached)
  - Market cap uses on-chain mint supply when available (no fixed 1B fallback)
  - Positions UI normalizes token amounts when stored decimals differ from on-chain
  - Execution loop uses on-chain decimals for new positions and adjusts sell size when mismatched
  - Pump.fun client now supports pump.pro account overrides via env:
    - `PUMP_PRO_GLOBAL_STATE`, `PUMP_PRO_FEE_RECIPIENT`, `PUMP_PRO_EVENT_AUTHORITY`, `PUMP_PRO_FEE_PROGRAM`
  - Bonding curve ATA derivation now uses the detected token program (no Token-2022 hardcode)
  - New helper: `packages/shared/src/pumpfun/onchain.ts` (bonding curve + mint info)

## 2026-01-19
- **feat(audit): Round 4 - Dynamic data displays + pump.pro bonding curve** (pending commit)
  - **Phase 1: DB Schema + Types**
    - Migration 019: Added `token_decimals`, `entry_mc_sol`, `entry_mc_usd` columns to positions
    - Updated PositionV31 interface with new display accuracy fields
    - Updated createPositionV31 to accept and insert new fields
  - **Phase 2: Market Data Helper**
    - New module: `packages/shared/src/marketData.ts`
    - `getMarketData()` - single token with pump.fun API â†’ DEXScreener â†’ Jupiter fallback
    - `getMarketDataBatch()` - batch fetch for position lists
    - `getExpectedSolOut()` - quote-based sell output (bonding curve or Jupiter)
    - `computeQuotePnl()` - accurate PnL using real sell quotes
  - **Phase 3: Bot Panel Updates**
    - Positions list shows current MC in USD (not entry MC)
    - Position detail shows both current MC and entry MC in USD
    - PnL displays as percentage AND SOL amount
  - **Phase 4: Execution Entry Data**
    - BUY handler now captures token_decimals (pump.fun=6, pump.pro=9)
    - Entry MC calculated and stored at buy time
    - Notification includes calculated entry MC
  - **Phase 5: TP/SL Monitor Pricing**
    - Both tpslMonitor.ts and positions.ts now use shared getTokenPrice()
    - Fallback chain: Jupiter â†’ DEXScreener â†’ pump.fun
  - **Phase 6: pump.pro Bonding Curve Support (CRITICAL)**
    - `deriveBondingCurvePDAForProgram()` - program-agnostic PDA derivation
    - `findBondingCurveAndProgram()` - checks both pump.fun AND pump.pro programs
    - All PDA derivation functions now accept programId parameter
    - Sell instruction uses correct program ID for pump.pro tokens
    - `getBondingCurveStateWithProgram()` in solanaExecutor.ts
    - Emergency sell now works for pump.pro tokens
- **fix(bot,hunter): emergency sell, entry price, MC display** (d10176d)
  - P0: Emergency sell not working - field name mismatch in emergencySellService.ts
    - Root cause: RPC returns `reservation_id` on success, but code read `execution_id`
    - Fix: Changed to `reservation_id || execution_id` for proper fallback
  - P0: Entry price wrong by 10^6 factor (5.35e-15 vs 5.35e-9)
    - Root cause: Price calculated with RAW tokens but we store ADJUSTED tokens (Ã·10^6)
    - Fix: Recalculate in execution.ts: `entryPrice = entryCostSol / adjustedSizeTokens`
  - P1: Entry MC shows "0.00 SOL" in position details
    - Root cause: `entry_mc_sol` column doesn't exist in DB, code defaults to 0
    - Fix: Calculate from entry price Ã— 1B total supply (pump.fun fixed supply)
  - P1: MC shown in SOL instead of USD
    - Root cause: `solPriceUsd` not fetched or passed to detail panel
    - Fix: Fetch SOL price via `getSolPrice()` and pass to panel for USD display
  - P2: Refresh button throws "message is not modified" error
    - Root cause: Telegram throws when editing message to identical content
    - Fix: Catch GrammyError and silently ignore when content unchanged
  - Data fix: Updated 4 positions with correct entry_price via SQL
    - entry_price was 10^6 too small; recalculated from entry_cost_sol / size_tokens
  - Data fix: Deleted 15 stale SELL executions with "Stale execution cleanup" error
    - These were blocking emergency sell retries due to idempotency check
  - Export: Added `getSolPrice` direct export from shared/index.ts
- **fix(bot): emergency sell stuck on "In Progress"** (82e2625)
  - Root cause: Code checked `status !== 'OPEN'` but database uses `status = 'ACTIVE'`
  - All ACTIVE positions incorrectly showed as "In Progress" and blocked emergency sell
  - Fixed positionsHandler.ts, positionDetail.ts, positions.ts to use 'ACTIVE'
  - Updated PositionStatus type in shared/types.ts: 'ACTIVE' | 'CLOSING' | 'CLOSING_EMERGENCY' | 'CLOSED'
- **fix(pricing): add DEXScreener fallback for pump.fun API failures** (82e2625)
  - pump.fun API returning 530 (Cloudflare blocked) causing price fetch failures
  - New fallback chain: Jupiter â†’ DEXScreener â†’ pump.fun
  - DEXScreener more reliable and handles most Solana tokens
  - Pricing module version bumped to v4.5
- **fix(executor): capture actual SOL spent on pump.fun buys** (82e2625)
  - Previously returned requested amount, not actual spend
  - Pump.fun bonding curve uses less SOL than requested
  - Added `getSolBalance()` helper to measure wallet balance before/after
  - `buyViaPumpFunWithKeypair` now returns `actualSolSpent` from balance change
  - Entry cost will now be accurate for future positions
- **fix(db): existing positions updated with correct entry costs**
  - 4 positions had 0.1 SOL (reserved budget) instead of ~0.017 SOL (actual spend)
  - Queried blockchain for actual transaction balances
  - Updated via SQL: PUMP 0.016973511, REDBULL 0.016973611, Watcher 0.016973, HODL 0.016973
  - Token symbols also fixed: Unknown â†’ HODL, Watcher, REDBULL (PUMP was correct)
- **fix(db): position limit bypass in reserve_trade_budget**
  - RPC was checking `status='OPEN'` but positions use `status='ACTIVE'`
  - This caused position count query to return 0, bypassing max_positions limit
  - Migration 018 fixes lines 204 and 220 to check 'ACTIVE' status
- **fix(hunter): token amount display wrong in notifications**
  - Raw token amounts were passed without decimal adjustment (pump.fun uses 6 decimals)
  - "3467850000000" displayed as "3467.85B" instead of "3.47M tokens"
  - Now divides by 10^6 before passing to notification
- **fix(hunter): token symbol "Unknown" in positions**
  - tokenSymbol was not passed from opportunity to createPositionV31
  - Now passes `opportunity?.token_symbol` during position creation
- **investigation: Jupiter circuit breaker failures**
  - Root cause: pump.pro tokens have bonding curves on different program ID
  - `deriveBondingCurvePDA` only checks pump.fun program, not pump.pro
  - When lookup fails, defaults to `graduated=true` â†’ routes to Jupiter â†’ fails
  - Future fix: check both program IDs for bonding curve derivation
- **feat(hunter): add market cap to BUY notifications**
  - Fetch token info from pump.fun API after successful BUY
  - Include `marketCapSol` in TRADE_DONE notification payload
  - Display "Entry MC: X.XX SOL" in notification panel
  - Graceful fallback if API fetch fails (no market cap shown)
- **fix(shared): positions not showing - status query mismatch**
  - `getOpenPositions()` and `getUserOpenPositions()` were querying for `status = 'OPEN'`
  - But `createPositionV31()` sets `status = 'ACTIVE'` (required by DB constraint)
  - Result: Positions created correctly but never returned by queries
  - Fix: Changed both queries to use `.eq('status', 'ACTIVE')`
- **fix(hunter): notification payload gaps**
  - High: TP/SL notifications now include `mint` for chart button and display
  - Low: TRADE_DONE now includes `tokenSymbol` from opportunity metadata
  - Moved opportunity fetch to success block scope for access in both position and notification code
- **fix(shared): critical position creation bug**
  - `createPositionV31()` was missing required columns: `token_address`, `amount_in`, `tokens_held`, `source`, `mode`, `strategy`
  - Status was 'OPEN' but constraint requires 'ACTIVE'|'CLOSED'|'PENDING'
  - Root cause: Trade executed but position insert failed with NOT NULL constraint violation
  - Impact: User tokens bought successfully but position not tracked (orphaned execution)
  - Fix: Added all required columns with correct values and constraint-compliant status
  - Manually created position for orphaned execution (user 5979211008)
- **feat(bot): upgrade all notification alerts to terminal UI**
  - Replaced old Markdown formatting with panelKit HTML terminal style
  - All notifications now use `ðŸ¦– RAPTOR | TITLE` header format with divider
  - Created 5 new notification component files:
    - `tradeDone.ts` - TRADE_DONE (BUY-only) notifications
    - `tpSlHit.ts` - TP_HIT, SL_HIT, TRAILING_STOP_HIT notifications
    - `positionState.ts` - POSITION_OPENED, POSITION_CLOSED notifications
    - `systemAlerts.ts` - BUDGET_WARNING, CIRCUIT_BREAKER, OPPORTUNITY_DETECTED
    - `generic.ts` - Terminal-style fallback for unknown notification types
  - NotificationPoller now uses `parse_mode: 'HTML'` and returns Panel objects
  - Generic notification no longer shows raw JSON, formats fields with labels
  - All notifications include action buttons (Positions, Home, View TX, etc.)
- **feat(hunter): token launch filtering modes**
  - Added 3 configurable filter modes: strict, moderate (default), light
  - Strict: Require socials + 3s delay + activity check (quality metadata, fail closed)
  - Moderate: 3s delay + activity check only (checks bondingCurveProgress > 0.5%, fail open)
  - Light: Require at least 1 social signal, no delay (fastest entry)
  - Activity check uses pump.fun API with on-chain bonding curve fallback
  - On-chain fallback reads realSolReserves directly when API returns 530
  - Reduces wasted gas and RPC calls on dead tokens
  - Migration 017 adds filter_mode column to strategies
  - Settings UI updated with Filter Mode selection
- **fix(hunter): position tracking data quality** (12ea0fa)
  - P0: Entry cost showing reserved budget (0.1 SOL) instead of actual spend (~0.0167)
    - Root cause: `entryCostSol: job.payload.amount_sol` used reserved budget, not actual spend
    - Fix: Added `amountIn` to TradeResult interface, mapped from executor result
    - Position now stores `result.amountIn` (actual SOL spent after fees)
  - P1: Token symbol "Unknown" - metadata not saved back to opportunity
    - Root cause: Metadata IS fetched for scoring but symbol NOT written back to DB
    - Fix: `updateOpportunityScore()` now accepts optional metadata parameter
    - Added `metadata` field to `ModeResult` interface for propagation
    - Save symbol from metadata when opportunity symbol is missing
  - P1: PnL shows 0.00% - never calculated for active positions
    - Root cause: No price fetching or calculation for ACTIVE positions
    - Fix: Created hybrid pricing module (`packages/shared/src/pricing.ts`)
    - Jupiter Price API primary (batch requests), pump.fun API fallback
    - 30-second in-memory cache to reduce API calls
    - Positions handler fetches real-time prices and calculates PnL on panel open
  - No paid Jupiter plan needed: Free tier (600 req/min) sufficient until 1000+ users

## 2026-01-18
- **fix(db): allow retryable auto jobs to reuse executions**
  - Added migration 016 to extend `reserve_trade_budget` with `p_allow_retry`
  - FAILED executions can be reused for retryable trade job attempts
  - Prevents immediate "Already executed" failures on queued retries
- **fix(hunter): per-user snipe scoring + opportunity lifecycle cleanup**
  - Score/metadata fetch now runs per snipe mode (speed vs quality) in parallel
  - Opportunities stay EXECUTING until DB terminal state (no early COMPLETED)
  - Auto-execute disabled blocks job creation (records QUALIFIED only)
  - Enforce `token_allowlist` when present
  - Remove unused `priority_fee_lamports` from job payloads (chain_settings remains source)
- **fix(bot): legacy hunt callbacks redirect to new panels**
  - All `hunt_*` callbacks open new Arm/Disarm flow and Settings
  - Snipe mode UI normalized to speed/quality (balanced treated as quality)
  - Slippage prompt text aligned to 1-99% validation
- **fix(shared): handle object errors in parseError** (d25ae0d)
  - Supabase errors are plain objects (not Error instances) thrown via `if (error) throw error;`
  - parseError was calling String(error) â†’ "[object Object]" instead of real message
  - Now extracts .message, .error, or .details from object errors
  - Fixes unhelpful error messages in job failure logs
- **fix(hunter): add job staleness check to ExecutionLoop** (d1b86f3)
  - Jobs older than 60 seconds are CANCELED (not FAILED) to avoid tripping circuit breaker
  - Pump.fun token launch windows expire quickly; stale jobs are useless
  - Fixes circuit breaker getting repeatedly tripped by old jobs failing
- **fix(hunter): relax scoring hard stops for pump.pro tokens**
  - pump.fun API returning HTTP 530 for pump.pro tokens AND Metaplex metadata doesn't exist
  - Temporarily changed metadata rules from hard stops to soft failures:
    - `has_metadata_uri`, `has_twitter`, `has_website`, `has_profile_image`
  - pump.pro tokens without metadata now use fallback name/symbol (mint-based)
  - Tokens can now pass scoring and be traded even without full metadata
  - TODO: Re-enable hard stops when pump.fun API is stable
- **fix(hunter): pump.pro on-chain metadata fallback**
  - pump.fun API returning HTTP 530 (service unavailable) for pump.pro tokens
  - Added fallback to fetch metadata from on-chain Metaplex Metadata Account
  - Fixed PumpFunApiResponse type to check for uri/metadata_uri fields (not just image_uri)
  - Tokens now get proper name/symbol/uri even when API is down
  - Fixes 100% rejection rate ("score: 0") for pump.pro tokens
- **fix(hunter): pump.pro API metadata fetch** (7e999bc)
  - pump.pro instructions don't include inline metadata like pump.fun
  - Detect pump.pro by discriminator, then fetch from frontend-api.pump.fun
  - 3s timeout on API call with graceful fallback
  - Fixes parse failures for all pump.pro token detections
- **fix(hunter): add pump.pro create discriminator** (15746be)
  - pump.pro uses new discriminator: `[147,241,123,100,244,132,174,118]`
  - PumpFunMonitor now checks all 3: legacy create, create_v2, pump.pro
  - Fixes 100% token parse failure on pump.pro transactions
  - Also reset circuit breaker (190 consecutive failures â†’ 0)
- **fix(bot): snipe mode panel errors** (5761fb9)
  - Remove checkmark emoji from buttons (violates panelKit no-emoji rule)
  - Use "[x] Speed" / "[x] Quality" for selected state instead
  - Add early return when clicking already-selected mode
- **fix(executor): prevent BigInt underflow and Jupiter slippage overflow** (565594f)
  - pumpFun.ts: Add validation in calculateBuyOutput/calculateSellOutput
  - jupiter.ts: Clamp slippageBps to 9900 max (99%)
  - supabase.ts: Fix TypeScript type errors with 'as const' assertions
  - Root cause: User had 1000% slippage causing negative BigInt calculations
- **fix(tpsl): standardize on uuid_id and fix critical RPC bugs** (cf9cb34)
  - P0: Migration 015 - All RPC functions now use `uuid_id` (was INTEGER `id`)
  - P0: Backfill NULL `uuid_id` values + add NOT NULL constraint
  - P0: Add unique index on `uuid_id` for race condition prevention
  - P1: Add `uuid_id` field to PositionV31 TypeScript interface
  - P1: Add `triggerExitAtomically()` wrapper in supabase.ts
  - P1: Fix `closePositionV31()` to use `uuid_id` for lookups
  - P2: Remove trigger-time notifications (moved to post-sell with real data)
  - P2: TRADE_DONE is now BUY-only; SELL uses TP_HIT/SL_HIT/etc.
  - Legacy monitor now uses atomic claim before creating exit jobs
  - All handlers (buy, sell, positions) now use uuid_id consistently
- **fix(tpsl): audit fixes for notification delivery and state machine** (bbfdd53)
  - P0: Start NotificationPoller in bot/index.ts (was never started - notifications never delivered)
  - P0: Fix notification type mapping: TAKE_PROFIT â†’ TP_HIT, STOP_LOSS â†’ SL_HIT
  - P0: Fix payload structure to match formatter expectations (tokenSymbol, pnlPercent, etc.)
  - P0: Fix createPositionV31 to use `tg_id` column (was using non-existent `user_id`)
  - P0: Populate trigger_state, tp_price, sl_price, bonding_curve at position creation
  - P1: Add markPositionExecuting, markTriggerCompleted, markTriggerFailed RPC wrappers
  - P1: Call state transitions in execution.ts before/after sell transactions
  - P1: Add trigger_state check to legacy positions.ts monitor (prevent duplicates)
  - P2: Use stored position.tp_price/sl_price when available (not strategy recompute)
  - Added getOpportunityById() to fetch bonding_curve from opportunity
- **fix(hunter): enforce metadata + dev-holdings hard stops**
  - Require metadata URI, X/Twitter, website, and image (Telegram optional)
  - Enforce creator holdings <= 10% of supply (hard stop)
  - Force metadata fetch even in speed snipe mode
- **fix(tpsl): improve exit state + notification accuracy**
  - Use position tokenSymbol in TP/SL notifications (not mint)
  - Always persist current_price updates in TP/SL monitor
  - Avoid early EXECUTING state in exit queue/legacy monitor
  - Mark triggers failed on unexpected SELL exceptions
  - Emergency sell notifications now use uuid_id
- **fix(bot): default base autohunt strategy to reduce launch flood**
  - New auto strategies default to stricter limits (positions/exposure/daily spend)
  - Raise min_score and cooldown for conservative default hunting
  - Pristine auto strategies are auto-updated to the new base defaults
- **chore(hunter): disable global deployer blacklist rule**
  - Blacklist enforcement removed until testing is complete
- **feat(bot): add snipe mode selection to Settings**
  - Speed vs Quality options with descriptions
  - Stores selection on the user's AUTO strategy
- **feat(hunter): begin TP/SL Engine implementation (Phase B)**
  - Hybrid architecture: Jupiter polling (3s) + Helius WebSocket activity hints
  - Trigger state machine: MONITORING â†’ TRIGGERED â†’ EXECUTING â†’ COMPLETED
  - Exactly-once semantics via atomic DB claims + idempotency keys
  - Exit queue with backpressure (maxConcurrent=3)
  - Feature-flagged migration path from legacy position monitor
  - Documentation updates: Architecture.md, CLAUDE.md, DESIGN.md, Reference_docs.md
- **feat(hunter): add pump.pro program support for token detection**
  - pump.fun has upgraded to new program: `proVF4pMXVaYqmy4NjniPh4pqKNfMmsihgd4wdkCX3u`
  - Most tokens now created via pump.pro instead of classic pump.fun
  - Added PUMP_PRO to PROGRAM_IDS in shared config
  - Monitor now subscribes to both pump.fun and pump.pro WebSocket logs
  - Parsing logic checks for Create instructions from both programs
- **fix(executor): clamp slippage to 99% max to prevent negative minTokens**
  - Settings handler now caps slippage input at 99% (was 1000%)
  - pumpFun.ts buy/sell now clamp slippageBps to 9900 max defensively
  - Root cause: User set 1000% slippage â†’ 100000 bps â†’ (10000-100000) = negative
  - This caused RangeError in encodeBuyData for BigUInt64LE
  - Fixed user's strategy slippage_bps from 100000 to 1500 (15%)
  - Reset circuit breaker after 5+ consecutive failures from this bug
- **fix(hunter): add create_v2 discriminator for pump.fun tokens**
  - pump.fun now uses `create_v2` instruction (not legacy `create`)
  - Legacy discriminator: `[24,30,200,40,5,28,7,119]` - sha256("global:create")[0..8]
  - Current discriminator: `[214,144,76,236,95,139,49,180]` - sha256("global:create_v2")[0..8]
  - Monitor now checks for both discriminators
  - Tokens now parsing successfully
- **fix(hunter): include ALT loaded addresses for versioned transactions**
  - Versioned transactions can have accounts in Address Lookup Tables (ALTs)
  - Was only reading `staticAccountKeys`, missing accounts from ALTs
  - Now combines: staticAccountKeys + loadedAddresses.writable + loadedAddresses.readonly
  - This fixes 100% parse failure when pump.fun program ID is in an ALT
- **chore(infra): migrate from QuickNode to Helius paid plan**
  - QuickNode free tier doesn't support `logsSubscribe` WebSocket method
  - Error: "1001 - upstream went away" immediately after subscription
  - Helius paid plan configured via Fly.io secrets
- **docs: document Fly.io auto-deploy from GitHub**
  - MUST_READ/DEPLOYMENT.md updated with auto-deploy section
  - No manual `fly deploy` needed for routine changes

## 2026-01-17
- **fix(hunter): handle both versioned and legacy tx parsing**
  - PumpFunMonitor was only handling versioned transactions (v0)
  - Now correctly handles legacy transactions as well
  - Versioned: staticAccountKeys, compiledInstructions, Uint8Array data
  - Legacy: accountKeys, instructions, base64 string data
  - This was causing 100% of token detections to fail parsing
- **fix(db): reset circuit breaker** (manual intervention)
  - Circuit breaker had 8 consecutive failures (threshold: 5)
  - Reset circuit_open_until and consecutive_failures to allow trades
- **fix(bot): settings panel text input not responding**
  - Added missing v3 autohunt settings session steps to messages.ts handleSessionFlow()
  - Now routes AWAITING_TRADE_SIZE, AWAITING_MAX_POSITIONS, AWAITING_TP_PERCENT,
    AWAITING_SL_PERCENT, AWAITING_SLIPPAGE_BPS, AWAITING_PRIORITY_SOL to handleSettingsInput()
  - Settings panel now properly updates values when user enters text
- **fix(bot): slippage now uses percentage instead of bps**
  - Display: shows "10%" instead of "1000 bps"
  - Input: accepts 1-1000% (converted to bps internally)
  - Better UX for high volatility launches that need 100%+ slippage
- **fix(hunter): pass tgId to executor for MEV/priority settings**
  - Hunter execution loop was not passing user ID to executor
  - Now passes `tgId: job.user_id` to `executeBuyWithKeypair` and `executeSellWithKeypair`
  - Executor now fetches user's chain_settings for priority_sol and anti_mev_enabled
  - Enables Jito MEV protection and custom priority fees for autohunt trades
- **fix(executor): pass priorityFeeSol to PumpFunClient buy/sell**
  - Was hardcoded to 100000 microLamports (~0.00002 SOL)
  - Now uses chain_settings.priority_sol from user preferences
  - Affects both buy and sell transactions on pump.fun bonding curve
- **feat(hunter): add mayhem mode filter**
  - Parse `is_mayhem_mode` from pump.fun Create instruction
  - Skip mayhem mode tokens in OpportunityLoop (low quality launches)
  - Added `isMayhemMode` field to PumpFunEvent interface
- **refactor(shared): remove unused PumpFun API functions**
  - Removed `getRecentTrades()` (never called)
  - Removed `PumpFunTrade` interface (only used by removed function)
  - Removed `parsePumpFunTrade()` (only used by removed function)
- **refactor(executor): remove dead code from pumpFun.ts**
  - Removed `parseCreateEvent()` (returned null)
  - Removed `parseTradeEvent()` (returned null)
  - Removed `PumpFunTrade` interface (only used by removed function)
- **docs: add PumpFun protocol reference to Reference_docs.md**
  - Bonding curve parameters and graduation threshold
  - Key 2025 protocol updates (volume accumulators, fee config, creator vault, mayhem mode)
  - Third-party API references

## 2026-01-16
- **feat(bot): add priority fee and MEV protection settings** (cb35d21)
  - Add Priority Fee setting to Settings UI (0.0001 - 0.01 SOL)
  - Add MEV Protection toggle (Jito) - ON by default
  - Uses chain_settings table for per-chain priority_sol and anti_mev_enabled
  - New callbacks: settings:edit_priority, settings:toggle_mev
- **fix(bot): arm/disarm autohunt bugs**
  - Re-validate settings in confirmArm() before enabling
  - Error handling in confirmDisarm() now updates UI on failure
- **fix(bot): shorten divider and add more bot menu commands** (d8f4dd8)
  - Shortened divider from 20 to 16 chars
  - Added /hunt, /positions, /wallet, /settings commands
- **fix(bot): implement emergency sell service** (P1 critical audit fix)
  - Added apps/bot/src/services/emergencySellService.ts
  - Uses idKeyExitSell for idempotency (one emergency sell per position)
  - Atomic budget reservation and execution tracking
  - High slippage (15%) for faster emergency exits
  - Proper position closing with EMERGENCY trigger
- **docs: deprecate Max Buys/Hour in favor of cooldown_seconds**
  - Max Buys/Hour was a design artifact never implemented in DB
  - cooldown_seconds provides same rate-limiting with better properties
  - Updated DESIGN.md, PROMPT.md, Project_status.md
- refactor(bot): implement v3 terminal UI with autohunt-only panels
- feat(ui): add panelKit.ts HTML renderer with width pad and linux joiners
- feat(ui): add all core panels - Home, Settings, Positions, Withdraw, Help
- feat(ui): add hunt panels - Arm/Disarm confirm, position details, emergency sell
- feat(ui): add notification panels - Hunt Executed/Closed/Skipped/Failed
- refactor(bot): rewrite callback router with new CB.* ID scheme
- remove(bot): disable manual buyer UI flows and callbacks
- remove(bot): disable /deposit command (users fund wallet directly)
- fix(withdraw): implement math validation with 0.01 SOL buffer
- fix(pnl): compute realized PnL from closed positions only
- fix(strategy): correct field names (max_positions, max_per_trade_sol)
- chore(db): add performance indexes for v3 queries

## 2026-01-15
- Added patched UI and placeholder removal work in prior audit iterations.
